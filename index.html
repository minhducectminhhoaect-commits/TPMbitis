<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPM Bitis App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f4f8; margin: 0; padding: 10px; color: #333; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none !important; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background: #0056b3; color: white; border: none; font-weight: 600; cursor: pointer; }
        button.secondary { background: #6c757d; }
        button.logout { background: transparent; color: #dc3545; border: 1px solid #dc3545; margin-top: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .role-badge { background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .ticket-item { border-left: 4px solid #0056b3; padding: 10px; background: #f8f9fa; margin-bottom: 10px; border-radius: 4px; }
        .ticket-item h4 { margin: 0 0 5px 0; font-size: 16px; }
        .ticket-item p { margin: 0 0 10px 0; color: #666; font-size: 13px; }
        .tabs { display: flex; margin-bottom: 15px; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 6px; font-weight: 600; cursor: pointer; color: #666; font-size: 14px; }
        .tab.active { background: white; color: #0056b3; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Dashboard styles */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-box { background: #fff; padding: 15px; text-align: center; border-radius: 8px; border: 1px solid #eee; }
        .kpi-num { font-size: 24px; font-weight: bold; color: #0056b3; display: block; }
        .kpi-label { font-size: 12px; color: #666; }
        .chart-box { background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="screen-login" class="card" style="max-width: 400px; margin: 40px auto;">
        <h2 style="text-align:center; color:#0056b3">TPM Đăng Nhập</h2>
        <input type="text" id="log-user" placeholder="Tên đăng nhập">
        <input type="password" id="log-pass" placeholder="Mật khẩu">
        <button onclick="handleLogin()">Đăng Nhập</button>
        <button class="secondary" onclick="showPublicDashboard()">Xem Dashboard (Không cần Login)</button>
        <p id="log-msg" style="color:red; text-align:center"></p>
    </div>

    <div id="screen-leader" class="hidden">
        <div class="header">
            <div>Chào, <b class="u-name"></b></div> <div class="role-badge">TỔ TRƯỞNG</div>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchLeaderTab(1)">1. Báo Hư</div>
            <div class="tab" onclick="switchLeaderTab(2)">2. Bảo Trì Đến</div>
            <div class="tab" onclick="switchLeaderTab(3)">3. Dashboard</div>
        </div>

        <div id="l-tab-1" class="card">
            <h3>Lập Phiếu Sự Cố</h3>
            <select id="l-chuyen">
                <option value="">-- Chọn Chuyền --</option>
                <option value="Hoàn chỉnh 1">Hoàn chỉnh 1</option>
                <option value="Hoàn chỉnh 2">Hoàn chỉnh 2</option>
                <option value="May 1">May 1</option>
                <option value="May 2">May 2</option>
                <option value="May 3">May 3</option>
                <option value="May 4">May 4</option>
                <option value="May 5">May 5</option>
                <option value="May 6">May 6</option>
                <option value="Dập 1">Dập 1</option>
                <option value="Dập 2">Dập 2</option>
                <option value="In lụa">In lụa</option>
                <option value="Bế hình">Bế hình</option>
                <option value="Cán dán">Cán dán</option>
                <option value="Cắt trục">Cắt trục</option>
                <option value="Ép dấu chân">Ép dấu chân</option>
                <option value="Chuẩn bị đế">Chuẩn bị đế</option>
                <option value="Bọc đế">Bọc đế</option>
                <option value="Bán thành phẩm">Bán thành phẩm</option>
                <option value="Cắt nhiệt">Cắt nhiệt</option>
                <option value="Phát sinh">Phát sinh</option>
            </select>
            <input type="text" id="l-msts" placeholder="Mã số tài sản (MSTS)">
            <label style="font-size:12px">Thời điểm máy hư:</label>
            <input type="datetime-local" id="l-time">
            <button onclick="leaderCreate()">Gửi Báo Cáo</button>
        </div>

        <div id="l-tab-2" class="hidden">
            <div class="card">
                <h3>Chờ Bảo Trì Có Mặt</h3>
                <div id="l-list"></div>
                <button class="secondary" onclick="loadLeaderOpen()">Làm mới danh sách</button>
            </div>
        </div>
        
        <div id="l-tab-3" class="hidden">
            <div id="dashboard-container-leader"></div>
        </div>
        
        <button class="logout" onclick="doLogout()">Đăng Xuất</button>
    </div>

    <div id="modal-assign" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:99; border:2px solid #0056b3">
        <h3>Xác nhận Bảo Trì Đến</h3>
        <input type="hidden" id="a-id"><input type="hidden" id="a-row">
        <p>MSTS: <b id="a-msts"></b></p>
        <label>Chọn Nhân Viên:</label>
        <select id="a-tech">
            <option value="">-- Chọn Tên --</option>
            <option value="Hoàng Đức Thuần">Hoàng Đức Thuần</option>
            <option value="Bùi Thanh Hoàng">Bùi Thanh Hoàng</option>
            <option value="Nguyễn Tuấn Khanh">Nguyễn Tuấn Khanh</option>
            <option value="Nguyễn Văn Khanh">Nguyễn Văn Khanh</option>
            <option value="Nguyễn Nhất Đẳng">Nguyễn Nhất Đẳng</option>
            <option value="Phan Văn Hồ">Phan Văn Hồ</option>
            <option value="Phạm Đắc Thụy">Phạm Đắc Thụy</option>
        </select>
        <label>Thời gian đến:</label>
        <input type="datetime-local" id="a-time">
        <button onclick="leaderAssignSubmit()">Xác Nhận</button>
        <button class="secondary" onclick="document.getElementById('modal-assign').classList.add('hidden')">Hủy</button>
    </div>

    <div id="screen-tech" class="hidden">
        <div class="header">
            <div>Chào, <b class="u-name"></b></div> <div class="role-badge">BẢO TRÌ</div>
        </div>
        <div class="card">
            <h3>Công Việc Của Tôi</h3>
            <div id="t-list"></div>
            <button class="secondary" onclick="loadTechJobs()">Làm mới danh sách</button>
        </div>
        <div class="card">
            <h3>Xem Dashboard</h3>
            <button class="secondary" onclick="showPublicDashboard()">Mở Dashboard</button>
        </div>
        <button class="logout" onclick="doLogout()">Đăng Xuất</button>
    </div>

    <div id="modal-finish" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:99; border:2px solid #28a745">
        <h3>Hoàn Tất Sửa Chữa</h3>
        <input type="hidden" id="f-id"><input type="hidden" id="f-row">
        <p>MSTS: <b id="f-msts"></b></p>
        <select id="f-nhomloi">
            <option value="Cơ khí">Lỗi Cơ khí</option>
            <option value="Điện">Lỗi Điện</option>
            <option value="Thủy lực">Lỗi Thủy lực</option>
            <option value="Khác">Khác</option>
        </select>
        <textarea id="f-bienphap" rows="3" placeholder="Biện pháp khắc phục"></textarea>
        <label>Thời gian xong:</label>
        <input type="datetime-local" id="f-time">
        <button style="background:#28a745" onclick="techFinishSubmit()">Hoàn Tất Phiếu</button>
        <button class="secondary" onclick="document.getElementById('modal-finish').classList.add('hidden')">Hủy</button>
    </div>

    <div id="screen-dashboard" class="hidden">
        <div class="header">
            <h3>TPM Dashboard</h3>
            <button class="secondary" style="width:auto; padding:5px 10px;" onclick="location.reload()">Quay lại</button>
        </div>
        
        <div class="card">
            <div style="display:flex; gap:10px;">
                <select id="d-vsm">
                    <option value="all">Tất cả VSM</option>
                    <option value="VSM 1">VSM 1</option>
                    <option value="VSM 2">VSM 2</option>
                </select>
                <button onclick="loadDashboardData()">Lọc</button>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-box">
                <span class="kpi-label">Tổng Phiếu</span>
                <span class="kpi-num" id="kpi-total">0</span>
            </div>
            <div class="kpi-box">
                <span class="kpi-label">Downtime (h)</span>
                <span class="kpi-num" id="kpi-dt">0</span>
            </div>
            <div class="kpi-box">
                <span class="kpi-label">MTTR (phút)</span>
                <span class="kpi-num" id="kpi-mttr">0</span>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="chart-line"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chart-tech"></canvas>
        </div>
    </div>

    <script>
        // ======================================================
        // QUAN TRỌNG: THAY URL WEB APP CỦA BẠN VÀO ĐÂY
        const API_URL = 'https://script.google.com/macros/s/AKfycbykRkSxU2WAw_O4rFWY_HZXcE9UAjot1NXARgIIbaexOiFvxLLRncGu76G4czn54t-_/exec'; 
        // ======================================================

        let currentUser = null;
        const vsmMap = {
            "Hoàn chỉnh 1": "VSM 1", "Hoàn chỉnh 2": "VSM 2", "May 1": "VSM 1", "May 2": "VSM 1",
            "May 3": "VSM 1", "May 4": "VSM 1", "May 5": "VSM 2", "May 6": "VSM 2",
            "Dập 1": "VSM 1", "Dập 2": "VSM 2", "In lụa": "VSM 1", "Bế hình": "VSM 1",
            "Cán dán": "VSM 1", "Cắt trục": "VSM 1", "Ép dấu chân": "VSM 2", "Chuẩn bị đế": "VSM 2",
            "Bọc đế": "VSM 2", "Bán thành phẩm": "VSM 2", "Cắt nhiệt": "VSM 1", "Phát sinh": "Phát sinh"
        };
        let chartLine = null;
        let chartTech = null;

        // --- COMMON ---
        function post(data, cb) {
            fetch(API_URL, {method:'POST', body:JSON.stringify(data)})
            .then(r=>r.json()).then(cb).catch(e=>alert('Lỗi: '+e));
        }
        function showScreen(id) {
            ['screen-login','screen-leader','screen-tech','screen-dashboard'].forEach(s=>document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- LOGIN ---
        function handleLogin() {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            if(!u || !p) return alert("Nhập đủ thông tin");
            
            document.querySelector('#screen-login button').innerText = "Đang tải...";
            post({action:'login', username:u, password:p}, res => {
                document.querySelector('#screen-login button').innerText = "Đăng Nhập";
                if(res.status !== 'success') return document.getElementById('log-msg').innerText = res.message;

                currentUser = res;
                document.querySelectorAll('.u-name').forEach(el => el.innerText = res.fullname);
                if(res.role === 'leader') {
                    showScreen('screen-leader');
                } else {
                    showScreen('screen-tech');
                    loadTechJobs();
                }
            });
        }
        function doLogout() { location.reload(); }

        // --- LEADER ---
        function switchLeaderTab(n) {
            document.getElementById('l-tab-1').classList.toggle('hidden', n!==1);
            document.getElementById('l-tab-2').classList.toggle('hidden', n!==2);
            document.getElementById('l-tab-3').classList.toggle('hidden', n!==3);
            
            document.querySelectorAll('.tab')[0].classList.toggle('active', n===1);
            document.querySelectorAll('.tab')[1].classList.toggle('active', n===2);
            document.querySelectorAll('.tab')[2].classList.toggle('active', n===3);
            
            if(n===2) loadLeaderOpen();
            if(n===3) {
                // Copy nội dung dashboard chung vào tab 3 của leader
                const dashContent = document.getElementById('screen-dashboard').innerHTML;
                document.getElementById('dashboard-container-leader').innerHTML = dashContent;
                loadDashboardData(true); // true = render vào container leader
            }
        }

        function leaderCreate() {
            const data = {
                chuyen: document.getElementById('l-chuyen').value,
                ma_so: document.getElementById('l-msts').value,
                gio_hu: document.getElementById('l-time').value
            };
            if(!data.ma_so || !data.gio_hu) return alert("Thiếu thông tin");
            post({action:'leader_create', data:data}, res => {
                alert(res.message);
                document.getElementById('l-msts').value = '';
            });
        }

        function loadLeaderOpen() {
            const div = document.getElementById('l-list');
            div.innerHTML = 'Đang tải...';
            post({action:'leader_get_open'}, res => {
                div.innerHTML = '';
                if(res.data.length === 0) return div.innerHTML = 'Không có phiếu chờ.';
                res.data.forEach(item => {
                   div.innerHTML += `
                    <div class="ticket-item">
                        <h4>${item.chuyen} - ${item.ma_so}</h4>
                        <p>Hư lúc: ${new Date(item.gio_hu).toLocaleString()}</p>
                        <button onclick='openAssign(${JSON.stringify(item)})'>Xác nhận Bảo Trì đến</button>
                    </div>`; 
                });
            });
        }

        function openAssign(item) {
            document.getElementById('a-id').value = item.id;
            document.getElementById('a-row').value = item.rowIndex;
            document.getElementById('a-msts').innerText = item.ma_so;
            document.getElementById('modal-assign').classList.remove('hidden');
        }

        function leaderAssignSubmit() {
            const d = {
                ten_bao_tri: document.getElementById('a-tech').value,
                gio_den: document.getElementById('a-time').value
            };
            if(!d.ten_bao_tri || !d.gio_den) return alert("Thiếu thông tin");
            post({action:'leader_assign', id:document.getElementById('a-id').value, rowIndex:document.getElementById('a-row').value, data:d}, res => {
                alert(res.message);
                document.getElementById('modal-assign').classList.add('hidden');
                loadLeaderOpen();
            });
        }

        // --- TECH ---
        function loadTechJobs() {
            const div = document.getElementById('t-list');
            div.innerHTML = 'Đang tải...';
            post({action:'tech_get_jobs', fullname: currentUser.fullname}, res => {
                div.innerHTML = '';
                if(res.data.length === 0) return div.innerHTML = 'Bạn không có công việc.';
                res.data.forEach(item => {
                   div.innerHTML += `
                    <div class="ticket-item" style="border-left-color:#28a745">
                        <h4>${item.chuyen} - ${item.ma_so}</h4>
                        <p>Vui lòng sửa chữa</p>
                        <button style="background:#28a745" onclick='openFinish(${JSON.stringify(item)})'>Cập nhật Hoàn Tất</button>
                    </div>`; 
                });
            });
        }

        function openFinish(item) {
            document.getElementById('f-id').value = item.id;
            document.getElementById('f-row').value = item.rowIndex;
            document.getElementById('f-msts').innerText = item.ma_so;
            document.getElementById('modal-finish').classList.remove('hidden');
        }

        function techFinishSubmit() {
            const d = {
                nhom_loi: document.getElementById('f-nhomloi').value,
                bien_phap: document.getElementById('f-bienphap').value,
                gio_xong: document.getElementById('f-time').value
            };
            if(!d.gio_xong) return alert("Thiếu giờ hoàn tất");
            post({action:'tech_finish', id:document.getElementById('f-id').value, rowIndex:document.getElementById('f-row').value, data:d}, res => {
                alert(res.message);
                document.getElementById('modal-finish').classList.add('hidden');
                loadTechJobs();
            });
        }

        // --- DASHBOARD ---
        function showPublicDashboard() {
            showScreen('screen-dashboard');
            loadDashboardData();
        }

        function loadDashboardData(isLeaderTab = false) {
            const suffix = isLeaderTab ? '-leader' : ''; // Logic xử lý ID nếu cần, ở đây dùng chung ID canvas vẫn chạy vì DOM replace
            // Lưu ý: Nếu dùng tab leader, canvas ID sẽ bị trùng. Để đơn giản, ta querySelector trong container
            
            // Để tránh lỗi duplicate canvas ID khi copy HTML, ta dùng biến toàn cục đơn giản.
            // Thực tế: Dashboard công cộng dùng ID gốc. Leader tab dùng innerHTML copy nên cần xử lý lại Chart instance.
            // Cách đơn giản nhất cho demo: Gọi API lấy data, sau đó tính toán và vẽ.
            
            post({action:'get_dashboard'}, res => {
                const data = res.data;
                const vsmFilter = document.getElementById('d-vsm') ? document.getElementById('d-vsm').value : 'all'; // Lấy giá trị filter
                
                // Filter Data
                const filtered = data.filter(item => {
                    const vsm = vsmMap[item.chuyen] || "Khác";
                    if(vsmFilter !== 'all' && vsm !== vsmFilter) return false;
                    return true;
                });

                // Calculate Metrics
                let totalDT = 0;
                let mttrCount = 0;
                const lineCounts = {};
                const techCounts = {};

                filtered.forEach(item => {
                    // Downtime (Giờ): Xong - Hư
                    if(item.gio_hu && item.gio_xong) {
                        const start = new Date(item.gio_hu);
                        const end = new Date(item.gio_xong);
                        const hours = (end - start) / (1000*60*60);
                        if(hours > 0) {
                            totalDT += hours;
                            mttrCount++;
                        }
                    }
                    // Count Line
                    lineCounts[item.chuyen] = (lineCounts[item.chuyen] || 0) + 1;
                    // Count Tech (nếu đã xong)
                    if(item.ten_bao_tri) techCounts[item.ten_bao_tri] = (techCounts[item.ten_bao_tri] || 0) + 1;
                });

                const mttr = mttrCount > 0 ? (totalDT * 60 / mttrCount).toFixed(1) : 0;

                // Update KPI Text
                // Tìm element trong container active
                const container = isLeaderTab ? document.getElementById('dashboard-container-leader') : document.body;
                
                container.querySelector('#kpi-total').innerText = filtered.length;
                container.querySelector('#kpi-dt').innerText = totalDT.toFixed(1);
                container.querySelector('#kpi-mttr').innerText = mttr;

                // Draw Charts
                drawChart(container.querySelector('#chart-line'), 'bar', 'Số phiếu theo Chuyền', Object.keys(lineCounts), Object.values(lineCounts));
                drawChart(container.querySelector('#chart-tech'), 'bar', 'Số phiếu theo Bảo trì', Object.keys(techCounts), Object.values(techCounts));
            });
        }

        function drawChart(canvas, type, label, labels, values) {
            // Hủy chart cũ nếu có gắn trên canvas này
            if(canvas.chartInstance) canvas.chartInstance.destroy();
            
            canvas.chartInstance = new Chart(canvas, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>

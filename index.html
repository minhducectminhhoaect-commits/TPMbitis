<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPM Mobile App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Mobile-first CSS */
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .hidden { display: none !important; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: 600; cursor: pointer; }
        button:active { transform: scale(0.98); }
        button.secondary { background: #6c757d; }
        button.logout { background: #fff; color: #dc3545; border: 1px solid #dc3545; margin-top: 10px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .role-badge { background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        /* Ticket Card Style */
        .ticket-item { border-left: 4px solid #007bff; padding: 12px; background: #f8f9fa; margin-bottom: 10px; border-radius: 4px; }
        .ticket-item h4 { margin: 0 0 5px 0; font-size: 16px; }
        .ticket-item p { margin: 0 0 10px 0; color: #666; font-size: 14px; }
        .ticket-action { display: flex; gap: 10px; }
        
        /* Tab Navigation */
        .tabs { display: flex; margin-bottom: 15px; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 6px; font-weight: 600; cursor: pointer; color: #666; }
        .tab.active { background: white; color: #007bff; shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="screen-login" class="card" style="max-width: 400px; margin: 50px auto;">
        <h2 style="text-align:center; margin-bottom: 20px;">TPM Bitis Đăng Nhập</h2>
        <input type="text" id="log-user" placeholder="Tên đăng nhập">
        <input type="password" id="log-pass" placeholder="Mật khẩu">
        <button onclick="handleLogin()">Đăng Nhập</button>
        <p id="log-msg" style="color:red; text-align:center; font-size:14px;"></p>
    </div>

    <div id="screen-leader" class="hidden">
        <div class="header">
            <div>Hi, <b class="u-name"></b></div>
            <div class="role-badge">TỔ TRƯỞNG</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('leader', 1)">1. Báo Hư</div>
            <div class="tab" onclick="switchTab('leader', 2)">2. Bảo Trì Đến</div>
        </div>

        <div id="leader-tab-1" class="card">
            <h3>Lập Phiếu Mới</h3>
            <select id="l-chuyen">
                <option value="">-- Chọn Chuyền --</option>
                <option value="May 1">May 1</option>
                <option value="May 2">May 2</option>
            </select>
            <input type="text" id="l-msts" placeholder="Mã số tài sản">
            <label style="font-size:12px; color:#666">Thời điểm máy hư:</label>
            <input type="datetime-local" id="l-time">
            <button onclick="leaderCreateTicket()">Gửi Báo Cáo</button>
        </div>

        <div id="leader-tab-2" class="hidden">
            <div class="card">
                <h3>Chờ Bảo Trì Có Mặt</h3>
                <p style="font-size:13px; color:#666">Danh sách máy đang hư chưa có người sửa:</p>
                <div id="leader-pending-list"></div>
                <button class="secondary" onclick="loadLeaderOpenTickets()">Làm mới</button>
            </div>
        </div>
        
        <button class="logout" onclick="doLogout()">Đăng Xuất</button>
    </div>

    <div id="modal-assign" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:100; border:2px solid #007bff">
        <h3>Xác nhận Bảo Trì Đến</h3>
        <input type="hidden" id="a-id"><input type="hidden" id="a-row">
        <p>Đang xử lý: <b id="a-msts"></b></p>
        
        <label>Người bảo trì:</label>
        <select id="a-tech">
            <option value="">-- Chọn Nhân Viên --</option>
            <option value="NV Bảo Trì A">NV Bảo Trì A</option>
            <option value="NV Bảo Trì B">NV Bảo Trì B</option>
        </select>
        
        <label>Thời gian đến:</label>
        <input type="datetime-local" id="a-time">
        
        <button onclick="leaderSubmitAssign()">Xác Nhận</button>
        <button class="secondary" onclick="document.getElementById('modal-assign').classList.add('hidden')">Hủy</button>
    </div>

    <div id="screen-tech" class="hidden">
        <div class="header">
            <div>Hi, <b class="u-name"></b></div>
            <div class="role-badge">BẢO TRÌ</div>
        </div>

        <div class="card">
            <h3>Công Việc Của Tôi</h3>
            <div id="tech-job-list"></div>
            <button class="secondary" onclick="loadTechJobs()">Làm mới danh sách</button>
        </div>
        <button class="logout" onclick="doLogout()">Đăng Xuất</button>
    </div>

    <div id="modal-finish" class="card hidden" style="position:fixed; top:10px; left:10px; right:10px; z-index:100; border:2px solid #28a745">
        <h3>Hoàn Tất Sửa Chữa</h3>
        <input type="hidden" id="f-id"><input type="hidden" id="f-row">
        <p>MSTS: <b id="f-msts"></b></p>
        
        <select id="f-nhomloi">
            <option value="Cơ khí">Lỗi Cơ Khí</option>
            <option value="Điện">Lỗi Điện</option>
            <option value="Khác">Khác</option>
        </select>
        <textarea id="f-bienphap" rows="3" placeholder="Biện pháp khắc phục..."></textarea>
        <label>Thời gian xong:</label>
        <input type="datetime-local" id="f-time">
        
        <button style="background:#28a745" onclick="techSubmitFinish()">Hoàn Tất</button>
        <button class="secondary" onclick="document.getElementById('modal-finish').classList.add('hidden')">Hủy</button>
    </div>

    <script>
        // ==========================================
        // DÁN URL CỦA BẠN VÀO ĐÂY
        const API_URL = 'https://script.google.com/macros/s/AKfycbykRkSxU2WAw_O4rFWY_HZXcE9UAjot1NXARgIIbaexOiFvxLLRncGu76G4czn54t-_/exec';
        // ==========================================

        let currentUser = null;

        // --- CORE FUNCTIONS ---
        function post(data, cb) {
            fetch(API_URL, { method: 'POST', body: JSON.stringify(data) })
                .then(r => r.json()).then(cb).catch(e => alert('Lỗi mạng: ' + e));
        }

        function handleLogin() {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            document.querySelector('#screen-login button').textContent = 'Đang xử lý...';
            
            post({action:'login', username:u, password:p}, res => {
                document.querySelector('#screen-login button').textContent = 'Đăng Nhập';
                if(res.status !== 'success') return document.getElementById('log-msg').textContent = res.message;
                
                currentUser = res;
                document.querySelectorAll('.u-name').forEach(el => el.textContent = res.fullname);
                document.getElementById('screen-login').classList.add('hidden');
                
                if(res.role === 'leader') {
                    document.getElementById('screen-leader').classList.remove('hidden');
                } else {
                    document.getElementById('screen-tech').classList.remove('hidden');
                    loadTechJobs();
                }
            });
        }

        function doLogout() { location.reload(); }

        // --- LEADER LOGIC ---
        function switchTab(role, tabIdx) {
            if(role === 'leader') {
                document.getElementById('leader-tab-1').classList.toggle('hidden', tabIdx !== 1);
                document.getElementById('leader-tab-2').classList.toggle('hidden', tabIdx !== 2);
                document.querySelectorAll('.tab')[0].classList.toggle('active', tabIdx === 1);
                document.querySelectorAll('.tab')[1].classList.toggle('active', tabIdx === 2);
                if(tabIdx === 2) loadLeaderOpenTickets();
            }
        }

        function leaderCreateTicket() {
            const data = {
                chuyen: document.getElementById('l-chuyen').value,
                ma_so: document.getElementById('l-msts').value,
                gio_hu: document.getElementById('l-time').value
            };
            if(!data.ma_so || !data.gio_hu) return alert("Vui lòng nhập đủ thông tin");
            
            post({action:'leader_create', data: data}, res => {
                alert(res.message);
                document.getElementById('l-msts').value = '';
            });
        }

        function loadLeaderOpenTickets() {
            const div = document.getElementById('leader-pending-list');
            div.innerHTML = 'Đang tải...';
            post({action:'leader_get_open'}, res => {
                div.innerHTML = '';
                if(res.data.length === 0) return div.innerHTML = '<p>Không có máy hư đang chờ.</p>';
                
                res.data.forEach(item => {
                    const dateStr = new Date(item.gio_hu).toLocaleString();
                    div.innerHTML += `
                        <div class="ticket-item">
                            <h4>${item.chuyen} - ${item.ma_so}</h4>
                            <p>Hư lúc: ${dateStr}</p>
                            <button onclick='openAssignModal(${JSON.stringify(item)})'>Bảo trì đã đến</button>
                        </div>
                    `;
                });
            });
        }

        function openAssignModal(item) {
            document.getElementById('a-id').value = item.id;
            document.getElementById('a-row').value = item.rowIndex;
            document.getElementById('a-msts').textContent = item.ma_so;
            document.getElementById('modal-assign').classList.remove('hidden');
        }

        function leaderSubmitAssign() {
            const payload = {
                action: 'leader_assign',
                id: document.getElementById('a-id').value,
                rowIndex: document.getElementById('a-row').value,
                data: {
                    ten_bao_tri: document.getElementById('a-tech').value,
                    gio_den: document.getElementById('a-time').value
                }
            };
            post(payload, res => {
                alert(res.message);
                document.getElementById('modal-assign').classList.add('hidden');
                loadLeaderOpenTickets();
            });
        }

        // --- TECH LOGIC ---
        function loadTechJobs() {
            const div = document.getElementById('tech-job-list');
            div.innerHTML = 'Đang tải...';
            post({action:'tech_get_jobs', fullname: currentUser.fullname}, res => {
                div.innerHTML = '';
                if(res.data.length === 0) return div.innerHTML = '<p>Bạn không có công việc nào.</p>';
                
                res.data.forEach(item => {
                    div.innerHTML += `
                        <div class="ticket-item" style="border-color:#28a745">
                            <h4>${item.chuyen} - ${item.ma_so}</h4>
                            <p>Đang chờ sửa chữa...</p>
                            <button onclick='openFinishModal(${JSON.stringify(item)})' style="background:#28a745">Cập nhật Hoàn tất</button>
                        </div>
                    `;
                });
            });
        }

        function openFinishModal(item) {
            document.getElementById('f-id').value = item.id;
            document.getElementById('f-row').value = item.rowIndex;
            document.getElementById('f-msts').textContent = item.ma_so;
            document.getElementById('modal-finish').classList.remove('hidden');
        }

        function techSubmitFinish() {
            const payload = {
                action: 'tech_finish',
                id: document.getElementById('f-id').value,
                rowIndex: document.getElementById('f-row').value,
                data: {
                    nhom_loi: document.getElementById('f-nhomloi').value,
                    bien_phap: document.getElementById('f-bienphap').value,
                    gio_xong: document.getElementById('f-time').value
                }
            };
            post(payload, res => {
                alert(res.message);
                document.getElementById('modal-finish').classList.add('hidden');
                loadTechJobs();
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPM Bitis System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f4f8; margin: 0; padding: 10px; color: #333; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none !important; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background: #0056b3; color: white; border: none; font-weight: 600; cursor: pointer; }
        button.secondary { background: #6c757d; }
        button.logout { background: transparent; color: #dc3545; border: 1px solid #dc3545; margin-top: 10px; }
        
        /* UI Tiện ích */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .role-badge { background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .alert-box { background: #ffebee; border: 1px solid #ffcdd2; padding: 10px; border-radius: 6px; margin-bottom: 15px; color: #c62828; }
        .ticket-item { border-left: 5px solid #ccc; padding: 12px; background: #fff; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .ticket-item.open { border-left-color: #dc3545; } 
        .ticket-item.assigned { border-left-color: #28a745; } 
        
        /* Dashboard Styles */
        .filter-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .filter-group > * { flex: 1; min-width: 120px; }
        
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .kpi-box { background: #fff; padding: 10px; text-align: center; border-radius: 8px; border: 1px solid #eee; }
        .kpi-num { font-size: 18px; font-weight: bold; color: #0056b3; display: block; }
        .kpi-label { font-size: 11px; color: #666; }
        .chart-container { background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; height: 250px; }
        h3 { margin-top: 0; font-size: 1.1rem; color: #444; }
    </style>
</head>
<body>

    <div id="screen-login" class="card" style="max-width: 400px; margin: 40px auto;">
        <h2 style="text-align:center; color:#0056b3">TPM Đăng Nhập</h2>
        <input type="text" id="log-user" placeholder="Tên đăng nhập">
        <input type="password" id="log-pass" placeholder="Mật khẩu">
        <button onclick="handleLogin()">Đăng Nhập</button>
        <button class="secondary" onclick="showDashboard(false)">Xem Dashboard (Khách)</button>
        <p id="log-msg" style="color:red; text-align:center"></p>
    </div>

    <div id="screen-leader" class="hidden">
        <div class="header">
            <div>Hi, <b class="u-name"></b></div> <div class="role-badge">TỔ TRƯỞNG</div>
        </div>
        <div class="card">
            <h3>1. Báo Máy Hư</h3>
            <select id="l-chuyen">
                <option value="">-- Chọn Chuyền --</option>
                <option value="May 1">May 1</option><option value="May 2">May 2</option>
                <option value="May 3">May 3</option><option value="May 4">May 4</option>
                <option value="May 5">May 5</option><option value="May 6">May 6</option>
                <option value="Hoàn chỉnh 1">Hoàn chỉnh 1</option><option value="Hoàn chỉnh 2">Hoàn chỉnh 2</option>
                <option value="Dập 1">Dập 1</option><option value="Dập 2">Dập 2</option>
                <option value="In lụa">In lụa</option><option value="Bế hình">Bế hình</option>
                <option value="Cán dán">Cán dán</option><option value="Cắt trục">Cắt trục</option>
                <option value="Ép dấu chân">Ép dấu chân</option><option value="Chuẩn bị đế">Chuẩn bị đế</option>
                <option value="Bọc đế">Bọc đế</option><option value="Bán thành phẩm">Bán thành phẩm</option>
                <option value="Cắt nhiệt">Cắt nhiệt</option><option value="Phát sinh">Phát sinh</option>
            </select>
            <input type="text" id="l-msts" placeholder="Mã số tài sản (MSTS)">
            <label style="font-size:12px">Thời điểm hư:</label>
            <input type="datetime-local" id="l-time">
            <button onclick="leaderCreate()">Gửi Báo Cáo</button>
        </div>

        <div class="card">
            <h3>2. Chờ Bảo Trì Đến (<span id="count-open">0</span>)</h3>
            <div id="l-list"></div>
            <button class="secondary" onclick="loadLeaderOpen()">Làm mới</button>
        </div>
        
        <button style="background:#17a2b8" onclick="showDashboard(true)">Xem Dashboard Chi Tiết</button>
        <button class="logout" onclick="doLogout()">Đăng Xuất</button>
    </div>

    <div id="modal-assign" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:99; border:2px solid #0056b3">
        <h3>Xác nhận Bảo Trì Đến</h3>
        <input type="hidden" id="a-id"><input type="hidden" id="a-row">
        <p>Máy: <b id="a-msts"></b></p>
        <label>Nhân Viên:</label>
        <select id="a-tech">
            <option value="">-- Chọn Tên --</option>
            <option value="Hoàng Đức Thuần">Hoàng Đức Thuần</option>
            <option value="Bùi Thanh Hoàng">Bùi Thanh Hoàng</option>
            <option value="Nguyễn Tuấn Khanh">Nguyễn Tuấn Khanh</option>
            <option value="Nguyễn Văn Khanh">Nguyễn Văn Khanh</option>
            <option value="Nguyễn Nhất Đẳng">Nguyễn Nhất Đẳng</option>
            <option value="Phan Văn Hồ">Phan Văn Hồ</option>
            <option value="Phạm Đắc Thụy">Phạm Đắc Thụy</option>
        </select>
        <label>Thời gian đến:</label>
        <input type="datetime-local" id="a-time">
        <button onclick="leaderAssignSubmit()">Xác Nhận</button>
        <button class="secondary" onclick="document.getElementById('modal-assign').classList.add('hidden')">Hủy</button>
    </div>

    <div id="screen-tech" class="hidden">
        <div class="header">
            <div>Hi, <b class="u-name"></b></div> <div class="role-badge">BẢO TRÌ</div>
        </div>

        <div id="tech-alert-area" class="hidden">
            <div class="alert-box">
                <strong>⚠️ CẦN TRỢ GIÚP!</strong>
                <p style="margin:5px 0; font-size:13px">Các chuyền sau đang báo hư nhưng chưa có người đến:</p>
                <div id="tech-alert-list"></div>
            </div>
        </div>

        <div class="card">
            <h3>Việc Của Tôi (<span id="count-myjob">0</span>)</h3>
            <div id="t-list"></div>
            <button class="secondary" onclick="loadTechJobs()">Làm mới</button>
        </div>
        
        <button style="background:#17a2b8" onclick="showDashboard(true)">Xem Dashboard Chi Tiết</button>
        <button class="logout" onclick="doLogout()">Đăng Xuất</button>
    </div>

    <div id="modal-finish" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:99; border:2px solid #28a745">
        <h3>Hoàn Tất Sửa Chữa</h3>
        <input type="hidden" id="f-id"><input type="hidden" id="f-row">
        <p>Máy: <b id="f-msts"></b></p>
        
        <label>Nhóm lỗi:</label>
        <input type="text" id="f-nhomloi" placeholder="Ví dụ: Cơ khí, Điện...">
        <label>Biện pháp:</label>
        <textarea id="f-bienphap" rows="3" placeholder="Đã thay linh kiện..."></textarea>
        <label>Thời gian xong:</label>
        <input type="datetime-local" id="f-time">
        
        <button style="background:#28a745" onclick="techFinishSubmit()">Lưu & Hoàn Tất</button>
        <button class="secondary" onclick="document.getElementById('modal-finish').classList.add('hidden')">Hủy</button>
    </div>

    <div id="screen-dashboard" class="hidden">
        <div class="header">
            <h3>Dashboard TPM</h3>
            <button class="secondary" style="width:auto; padding:5px 15px;" onclick="goBack()">Quay Lại</button>
        </div>
        
        <div class="card">
            <div class="filter-group">
                <select id="d-vsm">
                    <option value="all">Tất cả VSM</option>
                    <option value="VSM 1">VSM 1</option>
                    <option value="VSM 2">VSM 2</option>
                </select>
                <select id="d-line">
                    <option value="all">Tất cả Chuyền</option>
                    <option value="May 1">May 1</option><option value="May 2">May 2</option>
                    <option value="May 3">May 3</option><option value="May 4">May 4</option>
                    <option value="May 5">May 5</option><option value="May 6">May 6</option>
                    <option value="Hoàn chỉnh 1">Hoàn chỉnh 1</option><option value="Hoàn chỉnh 2">Hoàn chỉnh 2</option>
                    <option value="Dập 1">Dập 1</option><option value="Dập 2">Dập 2</option>
                    <option value="In lụa">In lụa</option><option value="Bế hình">Bế hình</option>
                    <option value="Cán dán">Cán dán</option><option value="Cắt trục">Cắt trục</option>
                    <option value="Ép dấu chân">Ép dấu chân</option><option value="Chuẩn bị đế">Chuẩn bị đế</option>
                    <option value="Bọc đế">Bọc đế</option><option value="Bán thành phẩm">Bán thành phẩm</option>
                    <option value="Cắt nhiệt">Cắt nhiệt</option><option value="Phát sinh">Phát sinh</option>
                </select>
            </div>
            <div class="filter-group">
                <input type="date" id="d-start" title="Từ ngày">
                <input type="date" id="d-end" title="Đến ngày">
            </div>
            <div class="filter-group">
                <button onclick="loadDashboardData()">Lọc Dữ Liệu</button>
                <button class="secondary" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-box"><span class="kpi-num" id="kpi-total">0</span><span class="kpi-label">Tổng Phiếu</span></div>
            <div class="kpi-box"><span class="kpi-num" id="kpi-dt">0</span><span class="kpi-label">Downtime (h)</span></div>
            <div class="kpi-box"><span class="kpi-num" id="kpi-mttr">0</span><span class="kpi-label">MTTR (phút)</span></div>
        </div>

        <div class="chart-container"><canvas id="c-line-ticket"></canvas></div>
        <div class="chart-container"><canvas id="c-line-dt"></canvas></div>
        <div class="chart-container"><canvas id="c-tech-ticket"></canvas></div>
        <div class="chart-container"><canvas id="c-tech-mttr"></canvas></div>
    </div>

    <script>
        // ==============================================
        // DÁN URL WEB APP CỦA BẠN VÀO ĐÂY
        const API_URL = 'https://script.google.com/macros/s/AKfycbykRkSxU2WAw_O4rFWY_HZXcE9UAjot1NXARgIIbaexOiFvxLLRncGu76G4czn54t-_/exec'; 
        // ==============================================

        let currentUser = null;
        let refreshInterval = null;
        const vsmMap = {
            "Hoàn chỉnh 1": "VSM 1", "Hoàn chỉnh 2": "VSM 2", "May 1": "VSM 1", "May 2": "VSM 1",
            "May 3": "VSM 1", "May 4": "VSM 1", "May 5": "VSM 2", "May 6": "VSM 2",
            "Dập 1": "VSM 1", "Dập 2": "VSM 2", "In lụa": "VSM 1", "Bế hình": "VSM 1",
            "Cán dán": "VSM 1", "Cắt trục": "VSM 1", "Ép dấu chân": "VSM 2", "Chuẩn bị đế": "VSM 2",
            "Bọc đế": "VSM 2", "Bán thành phẩm": "VSM 2", "Cắt nhiệt": "VSM 1", "Phát sinh": "Phát sinh"
        };

        // --- COMMON ---
        function post(data, cb) {
            fetch(API_URL, {method:'POST', body:JSON.stringify(data)})
            .then(r=>r.json()).then(cb).catch(e=>console.error(e));
        }
        
        function showScreen(id) {
            document.querySelectorAll('body > div[id^="screen-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function goBack() {
            if (!currentUser) showScreen('screen-login');
            else if (currentUser.role === 'leader') showScreen('screen-leader');
            else if (currentUser.role === 'maintenance') showScreen('screen-tech');
        }

        // --- LOGIN ---
        function handleLogin() {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            document.querySelector('#screen-login button').innerText = "Đang tải...";
            
            post({action:'login', username:u, password:p}, res => {
                document.querySelector('#screen-login button').innerText = "Đăng Nhập";
                if(res.status !== 'success') return document.getElementById('log-msg').innerText = res.message;

                currentUser = res;
                document.querySelectorAll('.u-name').forEach(el => el.innerText = res.fullname);
                
                if(res.role === 'leader') {
                    showScreen('screen-leader');
                    loadLeaderOpen();
                } else {
                    showScreen('screen-tech');
                    loadTechJobs();
                    startAutoRefresh();
                }
            });
        }
        function doLogout() { if(refreshInterval) clearInterval(refreshInterval); location.reload(); }

        // --- LEADER ---
        function leaderCreate() {
            const data = {
                chuyen: document.getElementById('l-chuyen').value,
                ma_so: document.getElementById('l-msts').value,
                gio_hu: document.getElementById('l-time').value
            };
            if(!data.ma_so || !data.gio_hu) return alert("Thiếu thông tin");
            post({action:'leader_create', data:data}, res => {
                alert(res.message);
                document.getElementById('l-msts').value = '';
                loadLeaderOpen();
            });
        }
        function loadLeaderOpen() {
            const div = document.getElementById('l-list');
            div.innerHTML = 'Đang tải...';
            post({action:'leader_get_open'}, res => {
                div.innerHTML = '';
                document.getElementById('count-open').innerText = res.data.length;
                res.data.forEach(item => {
                   div.innerHTML += `
                    <div class="ticket-item open">
                        <h4>${item.chuyen} - ${item.ma_so}</h4>
                        <p>Hư lúc: ${new Date(item.gio_hu).toLocaleString()}</p>
                        <button onclick='openAssign(${JSON.stringify(item)})'>Bảo Trì Đã Đến</button>
                    </div>`; 
                });
            });
        }
        function openAssign(item) {
            document.getElementById('a-id').value = item.id;
            document.getElementById('a-row').value = item.rowIndex;
            document.getElementById('a-msts').innerText = item.ma_so;
            document.getElementById('modal-assign').classList.remove('hidden');
        }
        function leaderAssignSubmit() {
            const d = { ten_bao_tri: document.getElementById('a-tech').value, gio_den: document.getElementById('a-time').value };
            post({action:'leader_assign', id:document.getElementById('a-id').value, rowIndex:document.getElementById('a-row').value, data:d}, res => {
                alert(res.message);
                document.getElementById('modal-assign').classList.add('hidden');
                loadLeaderOpen();
            });
        }

        // --- TECH ---
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if(!document.getElementById('screen-tech').classList.contains('hidden')) loadTechJobs(true);
            }, 15000); 
        }
        function loadTechJobs(silent = false) {
            const divMy = document.getElementById('t-list');
            const divAlert = document.getElementById('tech-alert-list');
            const alertArea = document.getElementById('tech-alert-area');
            if(!silent) divMy.innerHTML = 'Đang tải...';
            
            post({action:'tech_get_jobs', fullname: currentUser.fullname}, res => {
                // Alert Open Jobs
                divAlert.innerHTML = '';
                if(res.data.alertJobs.length > 0) {
                    alertArea.classList.remove('hidden');
                    res.data.alertJobs.forEach(item => {
                        divAlert.innerHTML += `<div style="border-bottom:1px dashed #ccc; padding:5px;"><b>${item.chuyen}</b>: ${item.ma_so}</div>`;
                    });
                } else {
                    alertArea.classList.add('hidden');
                }
                // My Jobs
                divMy.innerHTML = '';
                document.getElementById('count-myjob').innerText = res.data.myJobs.length;
                if(res.data.myJobs.length === 0) {
                    if(!silent) divMy.innerHTML = 'Chưa có việc được giao.';
                } else {
                    res.data.myJobs.forEach(item => {
                       divMy.innerHTML += `
                        <div class="ticket-item assigned">
                            <h4>${item.chuyen} - ${item.ma_so}</h4>
                            <p>Trạng thái: Đang chờ sửa</p>
                            <button style="background:#28a745" onclick='openFinish(${JSON.stringify(item)})'>Cập nhật Hoàn Tất</button>
                        </div>`; 
                    });
                }
            });
        }
        function openFinish(item) {
            document.getElementById('f-id').value = item.id;
            document.getElementById('f-row').value = item.rowIndex;
            document.getElementById('f-msts').innerText = item.ma_so;
            document.getElementById('modal-finish').classList.remove('hidden');
        }
        function techFinishSubmit() {
            const d = {
                nhom_loi: document.getElementById('f-nhomloi').value,
                bien_phap: document.getElementById('f-bienphap').value,
                gio_xong: document.getElementById('f-time').value
            };
            if(!d.gio_xong) return alert("Nhập giờ xong!");
            post({action:'tech_finish', id:document.getElementById('f-id').value, rowIndex:document.getElementById('f-row').value, data:d}, res => {
                alert(res.message);
                document.getElementById('modal-finish').classList.add('hidden');
                loadTechJobs();
            });
        }

        // --- DASHBOARD ---
        let charts = {};
        
        // Hàm Reset
        function resetFilters() {
            document.getElementById('d-vsm').value = 'all';
            document.getElementById('d-line').value = 'all';
            // Set ngày về đầu tháng - hôm nay
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('d-start').valueAsDate = firstDay;
            document.getElementById('d-end').valueAsDate = today;
            loadDashboardData();
        }

        function showDashboard(isLoggedIn) {
            showScreen('screen-dashboard');
            if(!document.getElementById('d-start').value) resetFilters();
            else loadDashboardData();
        }

        function loadDashboardData() {
            post({action:'get_dashboard'}, res => {
                const raw = res.data;
                const vsmVal = document.getElementById('d-vsm').value;
                const lineVal = document.getElementById('d-line').value;
                const start = new Date(document.getElementById('d-start').value);
                const end = new Date(document.getElementById('d-end').value); end.setHours(23,59);

                // FILTER LOGIC
                const filtered = raw.filter(i => {
                    // 1. Filter Date
                    const d = i.gio_hu ? new Date(i.gio_hu) : new Date();
                    if (d < start || d > end) return false;
                    
                    // 2. Filter VSM
                    const itemVSM = vsmMap[i.chuyen] || "Khác";
                    if (vsmVal !== 'all' && itemVSM !== vsmVal) return false;

                    // 3. Filter Line
                    if (lineVal !== 'all' && i.chuyen !== lineVal) return false;

                    return true;
                });

                // AGGREGATE
                let totalDT = 0;
                let mttrSum = 0;
                let mttrCount = 0;
                const lineStats = {};
                const techStats = {};

                filtered.forEach(i => {
                    const line = i.chuyen || "Khác";
                    const tech = i.ten_bao_tri || "Chưa gán";
                    
                    if(!lineStats[line]) lineStats[line] = {tk:0, dt:0};
                    if(!techStats[tech]) techStats[tech] = {tk:0, dt:0};

                    lineStats[line].tk++;
                    if(i.ten_bao_tri) techStats[tech].tk++;

                    if(i.gio_hu && i.gio_xong) {
                        const dtHours = (new Date(i.gio_xong) - new Date(i.gio_hu)) / 36e5; 
                        if(dtHours > 0) {
                            totalDT += dtHours;
                            lineStats[line].dt += dtHours;
                            if(i.ten_bao_tri) techStats[tech].dt += dtHours;
                            mttrSum += dtHours * 60; 
                            mttrCount++;
                        }
                    }
                });

                // UPDATE KPI
                document.getElementById('kpi-total').innerText = filtered.length;
                document.getElementById('kpi-dt').innerText = totalDT.toFixed(1);
                document.getElementById('kpi-mttr').innerText = mttrCount ? (mttrSum/mttrCount).toFixed(0) : 0;

                // UPDATE CHARTS
                drawChart('c-line-ticket', 'bar', 'Số phiếu theo Chuyền', lineStats, 'tk', '#36a2eb');
                drawChart('c-line-dt', 'bar', 'Downtime theo Chuyền (h)', lineStats, 'dt', '#ff6384');
                drawChart('c-tech-ticket', 'bar', 'Phiếu theo Bảo trì', techStats, 'tk', '#4bc0c0');
                
                const techLabels = Object.keys(techStats);
                const techMTTR = techLabels.map(t => techStats[t].tk ? ((techStats[t].dt*60)/techStats[t].tk).toFixed(0) : 0);
                drawChartSimple('c-tech-mttr', 'MTTR theo Bảo trì (p)', techLabels, techMTTR, '#ff9f40');
            });
        }

        function drawChart(id, type, label, dataObj, key, color) {
            const labels = Object.keys(dataObj);
            const vals = labels.map(l => dataObj[l][key]);
            drawChartSimple(id, label, labels, vals, color);
        }
        function drawChartSimple(id, label, labels, vals, color) {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: label, data: vals, backgroundColor: color }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
